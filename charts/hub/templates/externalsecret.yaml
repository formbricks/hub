{{- if and .Values.secrets.externalSecrets.enabled (not .Values.secrets.existingSecret) -}}
{{- $secretStore := required "values.secrets.externalSecrets.secretStore is required when externalSecrets.enabled=true" .Values.secrets.externalSecrets.secretStore -}}
{{- $awsSecretName := required "values.secrets.externalSecrets.awsSecretName is required when externalSecrets.enabled=true" .Values.secrets.externalSecrets.awsSecretName -}}
{{- $keys := .Values.secrets.externalSecrets.keys | default (list "DATABASE_URL" "API_KEY") }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "hub.secretName" . }}
  labels:
    {{- include "hub.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
    {{- with .Values.secrets.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ $secretStore | quote }}
    kind: ClusterSecretStore
  target:
    name: {{ include "hub.secretName" . }}
    creationPolicy: Owner
  data:
    {{- range $keys }}
    - secretKey: {{ . | quote }}
      remoteRef:
        key: {{ $awsSecretName | quote }}
        property: {{ . | quote }}
    {{- end }}
{{- end }}
