name: Release Docker Image to GHCR

on:
  workflow_call:
    inputs:
      MAKE_LATEST:
        description: "Whether to tag as latest (from GitHub release 'Set as the latest release' option)"
        required: false
        type: boolean
        default: false
    outputs:
      VERSION:
        description: "Release version"
        value: ${{ jobs.build.outputs.VERSION }}

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read

jobs:
  build:
    name: Build and push GHCR image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
      id-token: write
    outputs:
      VERSION: ${{ steps.extract_version.outputs.VERSION }}
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Extract release version from tag
        id: extract_version
        run: |
          set -euo pipefail

          # Extract tag name with fallback logic
          if [[ "$GITHUB_REF_NAME" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]] || [[ "$GITHUB_REF_NAME" =~ ^v[0-9] ]]; then
            TAG="$GITHUB_REF_NAME"
            echo "Using GITHUB_REF_NAME: $TAG"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            if [[ -z "$TAG" || "$TAG" == "$GITHUB_REF" ]]; then
              TAG="$GITHUB_REF_NAME"
              echo "Using GITHUB_REF_NAME as fallback: $TAG"
            else
              echo "Extracted from GITHUB_REF: $TAG"
            fi
          fi

          # Strip v-prefix if present
          TAG=${TAG#[vV]}

          # Validate SemVer format
          if [[ ! "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "ERROR: Invalid tag format '$TAG'. Expected SemVer (e.g., 1.0.0)"
            exit 1
          fi

          echo "VERSION=$TAG" >> $GITHUB_OUTPUT
          echo "Using version: $TAG"

      - name: Set up Depot CLI
        uses: depot/setup-action@b0b1ea4f69e92ebf5dea3f8713a1b0c37b2126a5 # v1.6.0

      - name: Install cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.2

      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Docker tags
        id: tags
        env:
          VERSION: ${{ steps.extract_version.outputs.VERSION }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          MAKE_LATEST: ${{ inputs.MAKE_LATEST }}
        run: |
          set -euo pipefail

          # Start with base version tag
          TAGS="ghcr.io/${IMAGE_NAME}:${VERSION}"

          # Add major.minor and major tags for proper SemVer releases
          if [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            MAJOR=$(echo "${VERSION}" | cut -d. -f1)
            MINOR=$(echo "${VERSION}" | cut -d. -f2)

            TAGS="${TAGS}\nghcr.io/${IMAGE_NAME}:${MAJOR}.${MINOR}"
            TAGS="${TAGS}\nghcr.io/${IMAGE_NAME}:${MAJOR}"

            echo "Added SemVer tags: ${MAJOR}.${MINOR}, ${MAJOR}"
          fi

          # Add latest tag for stable releases marked as latest
          if [[ "${MAKE_LATEST}" == "true" ]]; then
            TAGS="${TAGS}\nghcr.io/${IMAGE_NAME}:latest"
            echo "Added latest tag for stable release marked as latest"
          fi

          echo "Generated GHCR tags:"
          echo -e "${TAGS}"

          {
            echo "tags<<EOF"
            echo -e "${TAGS}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Build and push Docker image
        id: build
        uses: depot/build-push-action@636daae76684e38c301daa0c5eca1c095b24e780 # v1.14.0
        with:
          project: ${{ vars.DEPOT_PROJECT_ID }}
          token: ${{ secrets.DEPOT_PROJECT_TOKEN }}
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}

      - name: Sign image with cosign
        env:
          TAGS: ${{ steps.tags.outputs.tags }}
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          set -euo pipefail
          echo "${TAGS}" | xargs -I {} cosign sign --yes "{}@${DIGEST}"

      - name: Output build summary
        env:
          VERSION: ${{ steps.extract_version.outputs.VERSION }}
          TAGS: ${{ steps.tags.outputs.tags }}
        run: |
          echo "âœ… GHCR build completed successfully"
          echo "Version: ${VERSION}"
          echo "Tags pushed:"
          echo -e "${TAGS}"
