#!/bin/bash

# Git pre-commit hook to enforce code formatting and linting
# This hook runs before each commit to ensure code quality

set -e

# Add Go bin directories to PATH (git hooks run in minimal environment)
export PATH="$HOME/go/bin:${GOPATH:-$HOME/go}/bin:$PATH"

echo "Running pre-commit checks..."

# Check if golangci-lint is installed
if ! command -v golangci-lint >/dev/null 2>&1; then
    echo "Error: golangci-lint not found. Install it with: make install-tools"
    exit 1
fi

# Validate migrations if any staged file is in migrations/
STAGED_MIGRATIONS=$(git diff --cached --name-only --diff-filter=ACM | grep '^migrations/' || true)
if [ -n "$STAGED_MIGRATIONS" ]; then
    echo "Validating migration files..."
    if ! command -v goose >/dev/null 2>&1; then
        echo "Error: goose not found. Install it with: make install-tools"
        exit 1
    fi
    if ! make migrate-validate; then
        echo ""
        echo "❌ Migration validation failed. Fix the errors above before committing."
        exit 1
    fi
fi

# Format and fix fixable issues (gofumpt, gci, etc. from .golangci.yml)
echo "Running golangci-lint (format + fix)..."
if ! golangci-lint run --fix ./...; then
    echo ""
    echo "❌ Linting failed. Fix the errors above, then run: git add -u && git commit"
    exit 1
fi

# Stage any files that were auto-fixed (formatting, imports, etc.)
FIXED_FILES=$(git diff --name-only | grep '\.go$' || true)
if [ -n "$FIXED_FILES" ]; then
    echo "Staging auto-fixed files..."
    echo "$FIXED_FILES" | xargs git add
    echo "⚠️  Some files were auto-fixed and have been staged:"
    echo "$FIXED_FILES" | sed 's/^/    /'
fi

# Verify no remaining issues
echo "Running linter..."
if ! make lint; then
    echo ""
    echo "❌ Linting failed. Please fix the errors above before committing."
    exit 1
fi

echo "✅ Pre-commit checks passed!"
exit 0
